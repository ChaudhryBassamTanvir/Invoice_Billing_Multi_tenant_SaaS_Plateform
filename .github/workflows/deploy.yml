name: Auto Deploy to AWS
# minor update: workflow maintenance

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      DEPLOY_VERSION: "v1.0.1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: CI heartbeat
        run: echo "CI/CD pipeline active"

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@51.21.180.128 << 'EOF'
          set -ex
          cd ~/nimbus-app
          git fetch origin
          git reset --hard origin/master
          npm install
          npm run build
          pm2 restart nimbus-app --update-env
          EOF

